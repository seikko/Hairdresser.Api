@using Hairdresser.Api.Models.ViewModels
@model IEnumerable<Hairdresser.Api.Models.ViewModels.AppointmentViewModel>

@{
    var selectedDateStr = ViewData["SelectedDate"] as string ?? "";
    var selectedDate = DateTime.Parse(selectedDateStr);

    var workers = ViewData["Workers"] as IEnumerable<WorkerListViewModel>
        ?? Enumerable.Empty<WorkerListViewModel>();

    bool isToday = selectedDate.Date == DateTime.Today;
    var nowTime = DateTime.Now.TimeOfDay;

    var baseHours = Enumerable.Range(8, 13)
        .Select(h => new TimeSpan(h, 0, 0))
        .ToList();

    var extraSlots = Model
        .Select(a => TimeSpan.Parse(a.Time))
        .Where(t => t.Minutes != 0)
        .Distinct();

    var timeSlots = baseHours
        .Concat(extraSlots)
        .Distinct()
        .OrderBy(t => t)
        .ToList();
}

<div class="container my-4">

    <h5 class="mb-4 fw-bold" style="color:#354259">
        Randevular - @selectedDateStr
    </h5>

    <div class="table-responsive">
        <table class="table align-middle text-center shadow-sm">

            <thead style="background:#354259;color:white;">
                <tr>
                    <th style="width:180px;">Çalışan</th>
                    @foreach (var slot in timeSlots)
                    {
                        if (!(isToday && slot <= nowTime))
                        {
                            <th>@slot.ToString(@"hh\:mm")</th>
                        }
                    }
                </tr>
            </thead>

            <tbody>
                @foreach (var worker in workers)
                {
                    <tr>
                        <td class="fw-bold text-start ps-3">@worker.Name</td>

                        @foreach (var slot in timeSlots)
                        {
                            if (isToday && slot <= nowTime) { continue; }

                            var app = Model.FirstOrDefault(a =>
                                a.WorkerId == worker.Id &&
                                TimeSpan.Parse(a.Time) == slot
                            );

                            <td class="schedule-cell">

                                @if (app != null)
                                {
                                    <div class="randevu-cell
                                        @(app.Status=="confirmed" ? "appt-confirmed" :
                                          app.Status=="pending" ? "appt-pending" :
                                          "appt-cancelled")"
                                        onclick='showAppointmentModal(
                                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(app.CustomerName)),
                                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(app.PhoneNumber)),
                                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(app.ServiceType)),
                                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(app.Price)),
                                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(app.Time)),
                                            @app.Id
                                        )'>
                                        <span class="fw-bold small">@app.CustomerName</span>
                                        <span class="fst-italic small">@app.ServiceType</span>
                                        <span class="small fw-bold">@app.Price ₺</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="empty-cell"
                                        onclick="openCreate('@selectedDateStr','@worker.Id','@slot.ToString(@"hh\:mm")')">
                                        Randevu Oluştur
                                    </div>
                                }

                            </td>
                        }
                    </tr>
                }
            </tbody>

        </table>
    </div>
</div>

<!-- ================= MODAL ================= -->

<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg" style="border-radius:18px">

            <div class="modal-header" style="background:#354259;color:white">
                <h5 class="modal-title fw-bold">Randevu Detayı</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="mb-2">
                    <small class="text-muted">Müşteri</small>
                    <div id="custName" class="fw-bold">-</div>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Telefon</small>
                    <div id="custPhone">-</div>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Hizmet</small>
                    <div id="custService">-</div>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Ücret</small>
                    <div id="custPrice">-</div>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Saat</small>
                    <div id="custTime">-</div>
                </div>

            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a id="detailLink" class="btn btn-primary">Düzenle</a>
                <a id="cancelLink" class="btn btn-danger">İptal Et</a>
                <button class="btn btn-light" data-bs-dismiss="modal">Kapat</button>
            </div>

        </div>
    </div>
</div>

<style>
    body { background:#f3f5fb; }

    table { border-radius:18px; overflow:hidden; }

    .schedule-cell {
        width:95px; 
        height:85px; 
        padding:0; 
        border:1px solid #e6e8f0;
    }

    .randevu-cell {
        width:100%;
        height:100%;
        padding:8px;
        border-radius:14px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        cursor:pointer;
        color:white;
        font-size:13px;
        overflow:hidden; /* Uzun isim taşmasını önler */
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .appt-confirmed { background:#2fb36a; }
    .appt-pending { background:#ff9f29; color:#3d2b00; }
    .appt-cancelled { background:#c23636; }

    .empty-cell {
        width:100%;
        height:100%;
        border-radius:14px;
        border:2px dashed #cfd5eb;
        display:flex;
        justify-content:center;
        align-items:center;
        cursor:pointer;
        font-weight:600;
        font-size:13px;
        text-align:center;
    }
</style>

<script>
    function showAppointmentModal(name, phone, service, price, time, id) {

        document.getElementById("custName").innerText = name;
        document.getElementById("custPhone").innerText = phone;
        document.getElementById("custService").innerText = service;
        document.getElementById("custPrice").innerText = price + " ₺";
        document.getElementById("custTime").innerText = time;

        document.getElementById("detailLink").href = `/Appointments/Edit/${id}`;
        document.getElementById("cancelLink").href = `/Appointments/Delete/${id}`;

        new bootstrap.Modal(
            document.getElementById("appointmentModal")
        ).show();
    }

    function openCreate(date, workerId, time) {
        window.location.href =
            `/Appointments/Create?date=${date}&workerId=${workerId}&time=${time}`;
    }
</script>
