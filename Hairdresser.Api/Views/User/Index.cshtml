@model List<Hairdresser.Api.Models.ViewModels.UserListModel>

<div class="container my-4">
    <h2 class="mb-4">Kullanıcı Detayları</h2>

    <div class="row">
        <!-- Chart Panel -->
        <div class="col-lg-4 col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Randevu Durumu</h5>
                    <div style="position: relative; height:220px; width:220px; margin:auto;">
                        <canvas id="overallChart"></canvas>
                    </div>
                    <div class="chart-labels mt-3">
                        @{
                            var totalConfirmed = Model.Sum(u => u.ConfirmCount);
                            var totalCancelled = Model.Sum(u => u.CancelCount);
                            var totalAppointments = totalConfirmed + totalCancelled;
                            var confirmedPercent = totalAppointments > 0 ? (totalConfirmed * 100.0 / totalAppointments) : 0;
                            var cancelledPercent = totalAppointments > 0 ? (totalCancelled * 100.0 / totalAppointments) : 0;
                        }
                        <div>Toplam Randevu: <strong>@totalAppointments</strong></div>
                        <div style="color:#28a745;">Onaylı: <strong>@totalConfirmed</strong> (@confirmedPercent.ToString("0.#")%)</div>
                        <div style="color:#dc3545;">İptal: <strong>@totalCancelled</strong> (@cancelledPercent.ToString("0.#")%)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Panel -->
        <div class="col-lg-8 col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div style="overflow-x:auto;">
                        <table class="table table-hover table-bordered mb-0">
                            <thead class="table-primary">
                                <tr>
                                    <th>İsim</th>
                                    <th>Telefon</th>
                                    <th>Toplam Randevu</th>
                                    <th>Onaylı / Tamamlanan</th>
                                    <th>İptal Edilen</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var userItem in Model)
                                {
                                    var total = userItem.User.Appointments?.Count ?? 0;
                                    <tr>
                                        <td>@userItem.User.Name</td>
                                        <td class="user-phone">@FormatPhone(userItem.User.PhoneNumber)</td>
                                        <td>@total</td>
                                        <td><span class="badge-confirm">@userItem.ConfirmCount</span></td>
                                        <td><span class="badge-cancel">@userItem.CancelCount</span></td>
                                        <td>
                                            <a asp-action="Details" asp-route-id="@userItem.User.Id" class="btn btn-sm btn-primary">
                                                <i class="bi bi-clock-history"></i> Geçmişi Gör
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
h2 { color: #0072ff; }
.user-phone { color:#dc3545; font-weight:500; }
.badge-confirm { background-color:#28a745; color:#fff; padding:3px 8px; border-radius:12px; font-size:.85rem; }
.badge-cancel { background-color:#dc3545; color:#fff; padding:3px 8px; border-radius:12px; font-size:.85rem; }
.card-title { font-weight:600; }
.table-primary { background: linear-gradient(90deg, #00c6ff, #0072ff); color:#fff; text-align:center; font-weight:600; }
.table tbody td { vertical-align: middle; text-align:center; }
.table-hover tbody tr:hover { background-color: #e0f0ff; }
.chart-labels { font-weight:500; line-height:1.4; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctxOverall = document.getElementById('overallChart').getContext('2d');
new Chart(ctxOverall, {
    type: 'doughnut',
    data: {
        labels: ['Onaylı / Tamamlanan', 'İptal'],
        datasets: [{
            data: [@totalConfirmed, @totalCancelled],
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 1
        }]
    },
    options: {
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let total = @totalAppointments;
                        let percent = total > 0 ? (context.raw * 100 / total).toFixed(1) : 0;
                        return context.label + ': ' + context.raw + ' (' + percent + '%)';
                    }
                }
            }
        },
        cutout: '70%',
        responsive: true,
        maintainAspectRatio: false
    }
});
</script>

@functions {
    public string FormatPhone(string phone)
    {
        if (string.IsNullOrEmpty(phone)) return "-";
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        if (digits.Length == 10)
            return string.Format("{0} {1} {2} {3}", digits.Substring(0,3), digits.Substring(3,3), digits.Substring(6,2), digits.Substring(8,2));
        else if (digits.Length == 11 && digits.StartsWith("0"))
            return string.Format("{0} {1} {2} {3}", digits.Substring(0,4), digits.Substring(4,3), digits.Substring(7,2), digits.Substring(9,2));
        else
            return phone;
    }
}
